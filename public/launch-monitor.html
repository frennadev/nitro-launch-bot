<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nitro Launch Bot - Real-time Events</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: #ffffff;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(45deg, #4caf50, #45a049);
        border-radius: 10px;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      .panel {
        background: #2d2d2d;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #444;
      }
      .panel h3 {
        margin-top: 0;
        color: #4caf50;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }
      .event-log {
        height: 400px;
        overflow-y: auto;
        background: #1e1e1e;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 10px;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }
      .event-item {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 5px;
        border-left: 4px solid #4caf50;
      }
      .event-item.error {
        border-left-color: #ff4444;
        background: rgba(255, 68, 68, 0.1);
      }
      .event-item.warning {
        border-left-color: #ffaa00;
        background: rgba(255, 170, 0, 0.1);
      }
      .event-item.success {
        border-left-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }
      .timestamp {
        color: #888;
        font-size: 10px;
      }
      .controls {
        margin-bottom: 20px;
        text-align: center;
      }
      .controls input {
        padding: 8px;
        margin: 5px;
        border: 1px solid #444;
        background: #2d2d2d;
        color: #fff;
        border-radius: 5px;
      }
      .controls button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        background: #4caf50;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      .controls button:hover {
        background: #45a049;
      }
      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
      }
      .status.connected {
        background: #4caf50;
        color: white;
      }
      .status.disconnected {
        background: #ff4444;
        color: white;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #444;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        transition: width 0.3s ease;
      }
      .launch-card {
        background: #2d2d2d;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #444;
      }
      .launch-card.completed {
        border-color: #4caf50;
      }
      .launch-card h4 {
        margin: 0 0 10px 0;
        color: #4caf50;
      }
      .stage {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }
      .stage-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }
      .stage-icon.completed {
        background: #4caf50;
        color: white;
      }
      .stage-icon.pending {
        background: #666;
        color: #ccc;
      }
      .stage-icon.error {
        background: #ff4444;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üöÄ Nitro Launch Bot - Real-time Events</h1>
      <p>Monitor token launches and mixing progress in real-time</p>
      <span id="connectionStatus" class="status disconnected"
        >Disconnected</span
      >
    </div>

    <div class="controls">
      <input
        type="text"
        id="userIdInput"
        placeholder="Enter User ID (Telegram ID)"
      />
      <button onclick="subscribeToUser()">Subscribe to User Events</button>
      <button onclick="subscribeToAll()">
        Subscribe to All Events (Admin)
      </button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="container">
      <div class="panel">
        <h3>üìä Active Launches</h3>
        <div id="activeLaunches"></div>
      </div>

      <div class="panel">
        <h3>üìã Event Log</h3>
        <div id="eventLog" class="event-log"></div>
      </div>
    </div>

    <script>
      // Connect to Socket.IO server
      const socket = io("http://localhost:3001");

      // Track active launches
      const activeLaunches = new Map();

      // Connection status
      socket.on("connect", () => {
        updateConnectionStatus(true);
        logEvent("Connected to launch bot server", "success");
      });

      socket.on("disconnect", () => {
        updateConnectionStatus(false);
        logEvent("Disconnected from launch bot server", "error");
      });

      // Listen for token launch events
      socket.on("token_launch_event", (event) => {
        logEvent(
          `${event.stage.toUpperCase()}: ${event.name} (${event.symbol}) - ${event.message}`,
          getEventType(event.stage)
        );
        updateActiveLaunch(event);
      });

      // Listen for launch progress updates
      socket.on("launch_progress_update", (progress) => {
        logEvent(
          `Progress Update: ${progress.tokenAddress.slice(0, 8)}... - Step ${progress.currentStep}/${progress.totalSteps}`,
          "info"
        );
        updateLaunchProgress(progress);
      });

      function updateConnectionStatus(connected) {
        const statusElement = document.getElementById("connectionStatus");
        statusElement.textContent = connected ? "Connected" : "Disconnected";
        statusElement.className = `status ${connected ? "connected" : "disconnected"}`;
      }

      function subscribeToUser() {
        const userId = document.getElementById("userIdInput").value.trim();
        if (userId) {
          socket.emit("subscribe_user_launches", userId);
          logEvent(`Subscribed to launches for user: ${userId}`, "success");
        } else {
          alert("Please enter a User ID");
        }
      }

      function subscribeToAll() {
        socket.emit("subscribe_all_launches");
        logEvent("Subscribed to all launches (Admin mode)", "success");
      }

      function clearLogs() {
        document.getElementById("eventLog").innerHTML = "";
      }

      function logEvent(message, type = "info") {
        const eventLog = document.getElementById("eventLog");
        const timestamp = new Date().toLocaleTimeString();

        const eventItem = document.createElement("div");
        eventItem.className = `event-item ${type}`;
        eventItem.innerHTML = `
                <div class="timestamp">[${timestamp}]</div>
                <div>${message}</div>
            `;

        eventLog.appendChild(eventItem);
        eventLog.scrollTop = eventLog.scrollHeight;
      }

      function getEventType(stage) {
        switch (stage) {
          case "created":
          case "launched":
          case "mixing_completed":
          case "fully_ready":
            return "success";
          case "mixing_started":
            return "warning";
          default:
            return "info";
        }
      }

      function updateActiveLaunch(event) {
        const key = event.tokenAddress;

        if (!activeLaunches.has(key)) {
          activeLaunches.set(key, {
            tokenAddress: event.tokenAddress,
            platform: event.platform,
            name: event.name,
            symbol: event.symbol,
            stages: {
              created: false,
              launched: false,
              mixing_started: false,
              mixing_completed: false,
              fully_ready: false,
            },
          });
        }

        const launch = activeLaunches.get(key);
        launch.stages[event.stage] = true;

        // If error, mark as error
        if (event.error) {
          launch.error = event.error;
        }

        // Remove completed launches after 30 seconds
        if (event.stage === "fully_ready") {
          setTimeout(() => {
            activeLaunches.delete(key);
            renderActiveLaunches();
          }, 30000);
        }

        renderActiveLaunches();
      }

      function updateLaunchProgress(progress) {
        const key = progress.tokenAddress;
        if (activeLaunches.has(key)) {
          const launch = activeLaunches.get(key);
          launch.progress = progress;
          renderActiveLaunches();
        }
      }

      function renderActiveLaunches() {
        const container = document.getElementById("activeLaunches");
        container.innerHTML = "";

        if (activeLaunches.size === 0) {
          container.innerHTML =
            '<p style="color: #888; text-align: center;">No active launches</p>';
          return;
        }

        for (const [key, launch] of activeLaunches.entries()) {
          const card = document.createElement("div");
          card.className = `launch-card ${launch.stages.fully_ready ? "completed" : ""}`;

          const progressPercent = launch.progress
            ? Math.round(
                (launch.progress.currentStep / launch.progress.totalSteps) * 100
              )
            : 0;

          card.innerHTML = `
                    <h4>${launch.name} (${launch.symbol})</h4>
                    <p style="font-size: 12px; color: #888;">${launch.tokenAddress.slice(0, 16)}... | ${launch.platform.toUpperCase()}</p>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <p style="font-size: 12px; text-align: center; margin: 5px 0;">
                        ${launch.progress ? `Step ${launch.progress.currentStep}/${launch.progress.totalSteps}` : "Initializing..."}
                    </p>

                    <div class="stage">
                        <div class="stage-icon ${launch.stages.created ? "completed" : "pending"}">
                            ${launch.stages.created ? "‚úì" : "1"}
                        </div>
                        <span>Token Created</span>
                    </div>

                    <div class="stage">
                        <div class="stage-icon ${launch.stages.launched ? "completed" : "pending"}">
                            ${launch.stages.launched ? "‚úì" : "2"}
                        </div>
                        <span>Token Launched</span>
                    </div>

                    <div class="stage">
                        <div class="stage-icon ${launch.stages.mixing_completed ? "completed" : launch.stages.mixing_started ? "warning" : "pending"}">
                            ${launch.stages.mixing_completed ? "‚úì" : launch.stages.mixing_started ? "‚è≥" : "3"}
                        </div>
                        <span>Fund Mixing</span>
                    </div>

                    <div class="stage">
                        <div class="stage-icon ${launch.stages.fully_ready ? "completed" : "pending"}">
                            ${launch.stages.fully_ready ? "‚úì" : "4"}
                        </div>
                        <span>Fully Ready</span>
                    </div>

                    ${launch.error ? `<div style="color: #ff4444; font-size: 12px; margin-top: 10px;">‚ùå ${launch.error.message}</div>` : ""}
                `;

          container.appendChild(card);
        }
      }

      // Initial render
      renderActiveLaunches();
    </script>
  </body>
</html>
